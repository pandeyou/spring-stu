-- 用户
CREATE TABLE USERS  (
    ID BIGINT NOT NULL,
    GROUP_ID BIGINT NOT NULL,
    USERNAME VARCHAR(50),
    PASSWORD VARCHAR(157) NOT NULL,
    ENABLED INTEGER NOT NULL,
    CONSTRAINT PK_USER_ID PRIMARY KEY (ID)
);
-- 机构
CREATE TABLE GROUPS (
   ID BIGINT NOT NULL,
   PARENT_ID BIGINT NOT NULL,
   NAME VARCHAR(255),
   CONSTRAINT PK_GROUP_ID PRIMARY KEY (ID)
);

-- 机构，父机构 关系约束
ALTER TABLE GROUPS ADD CONSTRAINT FK_HD_GROUP_PARENT
  FOREIGN KEY (PARENT_ID) REFERENCES GROUPS(ID);
-- 用户，机构  约束关系
ALTER TABLE USERS ADD CONSTRAINT FK_USER_GROUP
  FOREIGN KEY (GROUP_ID) REFERENCES GROUPS(ID);
  
CREATE INDEX IDX_USER_GROUP_ID ON USERS(GROUP_ID);

CREATE INDEX IDX_GROUP_PARENT_ID ON GROUPS(PARENT_ID);

CREATE TABLE AUTHORITIES (
	ID BIGINT NOT NULL,
    USER_ID BIGINT NOT NULL,
    AUTHORITY VARCHAR(255) NOT NULL,
    CONSTRAINT PK_GROUP_ID PRIMARY KEY (ID)
);
CREATE UNIQUE INDEX UDX_AO_U_A ON AUTHORITIES  (USER_ID, AUTHORITY);
ALTER TABLE AUTHORITIES ADD CONSTRAINT AUTHORITIES_FK1 
	FOREIGN KEY (USER_ID) REFERENCES USERS (ID);
  
-- ACL受控对象数字型主键映射表
CREATE TABLE HD_ACL_OBJ_ID_MAP(
      ID BIGINT  NOT NULL,
      OBJECT_ID_CLASS BIGINT NOT NULL,
      OBJECT_ID_VALUE VARCHAR(255) NOT NULL,
     CONSTRAINT PK_HD_ACL_OBJ_ID_MAP PRIMARY KEY(ID)
);
CREATE UNIQUE INDEX UDX_ACL_OID_MAP_OID ON HD_ACL_OBJ_ID_MAP (OBJECT_ID_CLASS, OBJECT_ID_VALUE);
-- ACL受控对象类型登记表
CREATE TABLE HD_ACL_CLASS(
      ID BIGINT  NOT NULL,
      CLASS VARCHAR(100) NOT NULL,
      CONSTRAINT PK_HD_ACL_CLASS PRIMARY KEY(ID)
);
CREATE UNIQUE INDEX IDX_HD_ACL_CLASS ON HD_ACL_CLASS (CLASS);

-- ACL操作者登记表
CREATE TABLE HD_ACL_SID(
      ID BIGINT  NOT NULL,
      PRINCIPAL SMALLINT NOT NULL,
      SID VARCHAR(100) NOT NULL,
      CONSTRAINT PK_HD_ACL_SID PRIMARY KEY(ID)
);
CREATE UNIQUE INDEX IDX_HD_ACL_SID ON HD_ACL_SID (SID, PRINCIPAL);

-- ACL受控对象实例登记表
CREATE TABLE HD_ACL_OBJ_ID(
      ID BIGINT  NOT NULL,
      OBJECT_ID_CLASS BIGINT NOT NULL,
      OBJECT_ID_IDENTITY BIGINT NOT NULL,
      PARENT_OBJECT BIGINT,
      OWNER_SID BIGINT,
      ENTRIES_INHERITING SMALLINT NOT NULL,
     CONSTRAINT PK_HD_ACL_OBJ_ID PRIMARY KEY(ID)
);
ALTER TABLE HD_ACL_OBJ_ID ADD CONSTRAINT FK_HD_ACL_OBJ_ID_OCLASS
  FOREIGN KEY (OBJECT_ID_CLASS) REFERENCES HD_ACL_CLASS(ID);
CREATE INDEX IDX_HD_ACL_OBJ_ID_OCLASS ON HD_ACL_OBJ_ID (OBJECT_ID_CLASS);
ALTER TABLE HD_ACL_OBJ_ID ADD CONSTRAINT FK_HD_ACL_OBJ_ID_SID
  FOREIGN KEY (OWNER_SID) REFERENCES HD_ACL_SID(ID);
CREATE INDEX IDX_HD_ACL_OBJ_ID_SID ON HD_ACL_OBJ_ID (OWNER_SID);
ALTER TABLE HD_ACL_OBJ_ID ADD CONSTRAINT FK_HD_ACL_OBJ_ID_PARENT 
  FOREIGN KEY(PARENT_OBJECT) REFERENCES HD_ACL_OBJ_ID(ID);
CREATE INDEX IDX_HD_ACL_OBJ_ID_PARENT ON HD_ACL_OBJ_ID (PARENT_OBJECT);
CREATE UNIQUE INDEX UDX_HD_ACL_OBJ_ID_OID ON HD_ACL_OBJ_ID (OBJECT_ID_CLASS, OBJECT_ID_IDENTITY);

-- ACL授权信息
CREATE TABLE HD_ACL_ENTRY(
      ID BIGINT NOT NULL,
      HD_ACL_OBJ_ID BIGINT NOT NULL,
      ACE_ORDER INTEGER NOT NULL,
      SID BIGINT NOT NULL,
      MASK INTEGER NOT NULL,
      GRANTING SMALLINT NOT NULL,
      AUDIT_SUCCESS SMALLINT NOT NULL,
      AUDIT_FAILURE SMALLINT NOT NULL,
      CONSTRAINT PK_HD_ACL_ENTRY PRIMARY KEY(ID)
);
ALTER TABLE HD_ACL_ENTRY ADD CONSTRAINT FK_HD_ACL_ENTRY_OID
  FOREIGN KEY (HD_ACL_OBJ_ID) REFERENCES HD_ACL_OBJ_ID(ID);
ALTER TABLE HD_ACL_ENTRY ADD CONSTRAINT FK_HD_ACL_ENTRY_SID
  FOREIGN KEY (SID) REFERENCES HD_ACL_SID(ID);
CREATE INDEX IDX_HD_ACL_ENTRY_OID ON HD_ACL_ENTRY (HD_ACL_OBJ_ID);
CREATE INDEX IDX_HD_ACL_ENTRY_SID ON HD_ACL_ENTRY (SID);
